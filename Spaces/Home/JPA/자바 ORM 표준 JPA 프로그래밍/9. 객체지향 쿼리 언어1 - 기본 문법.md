### ì†Œê°œ

> **JPAì˜ ë‹¤ì–‘í•œ ì¿¼ë¦¬ ë°©ë²•**

- **JPQL**
- JPA Criteria
- **QueryDSL**
- ë„¤ì´í‹°ë¸Œ SQL
- JDBC API ì§ì ‘ ì‚¬ìš©, MyBatis, SpringJdbcTemplate í•¨ê»˜ ì‚¬ìš©

> **JPQL**

- ê°€ì¥ ë‹¨ìˆœí•œ ì¡°íšŒ ë°©ë²•
    - EntityManager.find()
- JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê°œë°œ ë¬¸ì œëŠ” ê²€ìƒ‰ ì¿¼ë¦¬
- ê²€ìƒ‰ì„ í•  ë•Œë„ í…Œì´ë¸”ì´ ì•„ë‹Œ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰
    - JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬
    - SQLì€ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬

```java
List<Member> resultList = em.createQuery(
        "select m from Member m where m.username like '%kim%'",
        Member.class
).getResultList();
```

<aside> ğŸ’¡ **í•œë§ˆë””ë¡œ ì •ì˜í•˜ë©´ ê°ì²´ ì§€í–¥ SQL**

</aside>

> **Ceiriteria**

- ìë°”ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- **ë„ˆë¬´ ë³µì¡í•˜ê³  ì‹¤ìš©ì—†ì´ ì—†ë‹¤**. â†’ ì‹¤ë¬´ì—ì„œ ì‚¬ìš© X QueryDSL ì‚¬ìš© ê¶Œì¥

```java
//Criteria ì‚¬ìš© ì¤€ë¹„
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);

Root<Member> m = query.from(Member.class);

CriteriaQuery<Member> cq = query.select(m).where(cb.equal(m.get("username"), "kim"));
List<Member> resultList = em.createQuery(cq).getResultList();

tx.commit();
```

> **QueryDSL**

- ë¬¸ìê°€ ì•„ë‹Œ ìë°”ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- JPQL ë¹Œë” ì—­í• 
- ì»´íŒŒì¼ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŒ
- ë™ì ì¿¼ë¦¬ ì‘ì„± í¸ë¦¬í•¨
- **ë‹¨ìˆœí•˜ê³  ì‰¬ì›€**
- **ì‹¤ë¬´ ì‚¬ìš© ê¶Œì¥**

```java
//JPQL
//select m from Member m where m.age > 18

JPAFactoryQuery query = new JPAQueryFactory(em);
QMember m = QMember.member;

List<Member> list =
	query.selectFrom(m)
			 .where(m.age.gt(18))
			 .orderBy(m.name.desc())
			 .fetch();
```

> **ë„¤ì´í‹°ë¸Œ SQL**

```java
String sql =
	 â€œSELECT ID, AGE, TEAM_ID, NAME FROM MEMBER WHERE NAME = â€˜kimâ€™";

List<Member> resultList =
						em.createNativeQuery(sql, Member.class).getResultList();
```

### ê¸°ë³¸ ë¬¸ë²•ê³¼ ì¿¼ë¦¬ API

> **JPQL ì†Œê°œ**

- JPQLì€ ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ë‹¤.ë”°ë¼ì„œ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬í•œë‹¤.
- JPQLì€ SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì •ë°ì´í„°ë² ì´ìŠ¤ SQLì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.
- JPQLì€ ê²°êµ­ SQLë¡œ ë³€í™˜ëœë‹¤.

> **JPQL ë¬¸ë²•**

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4c01c773-7889-4753-b192-aa87ce755357/Untitled.png)

- select m from Member as m where m.age > 18
- ì—”í‹°í‹°ì™€ ì†ì„±ì€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„O (Member, age)
- JPQL í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„X (SELECT, FROM, where)
- ì—”í‹°í‹° ì´ë¦„ ì‚¬ìš©, í…Œì´ë¸” ì´ë¦„ì´ ì•„ë‹˜(Member)
- ë³„ì¹­ì€ í•„ìˆ˜(m) (asëŠ” ìƒëµê°€ëŠ¥

> **ì§‘í•©ê³¼ ì •ë ¬**

- COUNT, SUM, AVG, MAX, MIN
- GROUP BY, HAVING
- ORDER BY

> **TypeQuery, Query**

- TypeQuery: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•  ë•Œ ì‚¬ìš©
    - TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m", Member.class);
- Query: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©
    - ex) String, int ì»¬ëŸ¼ì„ ê°™ì´ ì¡°íšŒí•  ë•Œ
    - Query query = em.createQuery("SELECT m.username, m.age from Member m");

> **íŒŒë¼ë¯¸í„° ë°”ì¸ë”©**

```java
SELECT m FROM Member m where m.username=:username query.setParameter("username", usernameParam);
```

```java
SELECT m FROM Member m where m.username=?1query.setParameter(1, usernameParam);
```

### í”„ë¡œì ì…˜(SELECT)

- SELECT ì ˆì— ì¡°íšŒí•  ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒ
- í”„ë¡œì ì…˜ ëŒ€ìƒ: ì—”í‹°í‹°, ì„ë² ë””ë“œ íƒ€ì…, ìŠ¤ì¹¼ë¼ íƒ€ì…(ìˆ«ì, ë¬¸ìë“± ê¸°ë³¸ ë°ì´í„° íƒ€ì…)
- SELECT **m** FROM Member m -> ì—”í‹°í‹° í”„ë¡œì ì…˜
- SELECT **m.team** FROM Member m -> ì—”í‹°í‹° í”„ë¡œì ì…˜
- SELECT **m.address** FROM Member m -> ì„ë² ë””ë“œ íƒ€ì… í”„ë¡œì ì…˜
- SELECT **m.username, m.age** FROM Member m -> ìŠ¤ì¹¼ë¼ íƒ€ì… í”„ë¡œì ì…˜
    - ë‹¨ìˆœ ê°’ì„ DTOë¡œ ë°”ë¡œ ì¡°íšŒ
    - SELECT new jpabook.jpql.UserDTO(m.username, m.age) FROM Member m
    - íŒ¨í‚¤ì§€ ëª…ì„ í¬í•¨í•œ ì „ì²´ í´ë˜ìŠ¤ ëª… ì…ë ¥
    - ìˆœì„œì™€ íƒ€ì…ì´ ì¼ì¹˜í•˜ëŠ” ìƒì„±ì í•„ìš”
- DISTINCTë¡œ ì¤‘ë³µ ì œê±°

### í˜ì´ì§•

- JPAëŠ” í˜ì´ì§•ì„ ë‹¤ìŒ ë‘ APIë¡œ ì¶”ìƒí™”
- setFirstResult(int startPosition) : ì¡°íšŒ ì‹œì‘ ìœ„ì¹˜(0ë¶€í„° ì‹œì‘)
- setMaxResults(int maxResult) : ì¡°íšŒí•  ë°ì´í„° ìˆ˜

```java
List<Member> resultList = em.createQuery("select m from Member m order by username desc", Member.class)
        .setFirstResult(1)
        .setMaxResults(10)
        .getResultList();
```

### ì¡°ì¸

- ë‚´ë¶€ ì¡°ì¸
    - SELECT m FROM Member m [INNER] JOIN m.team t
- ì™¸ë¶€ ì¡°ì¸
    - SELECT m FROM Member m LEFT [OUTER] JOIN m.team t
- ì„¸íƒ€ ì¡°ì¸:
    - SELECT count(m) FROM Member m, Team t WHERE m.username = [t.name](http://t.name)

> **ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§**

- ì˜ˆ) íšŒì›ê³¼ íŒ€ì„ ì¡°ì¸í•˜ë©´ì„œ, íŒ€ ì´ë¦„ì´ Aì¸ íŒ€ë§Œ ì¡°ì¸
    - JPQL
        - SELECT m, t FROM Member m LEFT JOIN m.team t on [t.name](http://t.name) = 'A'
    - SQL
        - SELECT m._, t._ FROM Member m LEFT JOIN Team t ON m.TEAM_ID=[t.id](http://t.id) and t.name='A'

> **ì—°ê´€ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸**

- ì˜ˆ) íšŒì›ì˜ ì´ë¦„ê³¼ íŒ€ì˜ ì´ë¦„ì´ ê°™ì€ ëŒ€ìƒ ì™¸ë¶€ ì¡°ì¸
    - JPQL
        - SELECT m, t FROM Member m LEFT JOIN Team t on m.username = [t.name](http://t.name)
    - SQL
        - SELECT m._, t._ FROM Member m LEFT JOIN Team t ON m.username = [t.name](http://t.name)

### ì„œë¸Œ ì¿¼ë¦¬

- ë‚˜ì´ê°€ í‰ê· ë³´ë‹¤ ë§ì€ íšŒì›
    - select m from Member m where m.age > (select avg(m2.age) from Member m2)
- í•œ ê±´ì´ë¼ë„ ì£¼ë¬¸í•œ ê³ ê°
    - select m from Member m where (select count(o) from Order o where m = o.member) > 0

> **ì„œë¸Œ ì¿¼ë¦¬ ì§€ì› í•¨ìˆ˜**

- [NOT] EXISTS (subquery): ì„œë¸Œì¿¼ë¦¬ì— ê²°ê³¼ê°€ ì¡´ì¬í•˜ë©´ ì°¸
    - {ALL | ANY | SOME} (subquery)
    - ALL ëª¨ë‘ ë§Œì¡±í•˜ë©´ ì°¸
    - ANY, SOME: ê°™ì€ ì˜ë¯¸, ì¡°ê±´ì„ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ì°¸
- [NOT] IN (subquery): ì„œë¸Œì¿¼ë¦¬ì˜ ê²°ê³¼ ì¤‘ í•˜ë‚˜ë¼ë„ ê°™ì€ ê²ƒì´ ìˆìœ¼ë©´ ì°¸

> **ì„œë¸Œ ì¿¼ë¦¬ - ì˜ˆì œ**

- íŒ€A ì†Œì†ì¸ íšŒì›
    - select m from Member m where exists (select t from m.team t where [t.name](http://t.name/) = â€˜íŒ€A')
- ì „ì²´ ìƒí’ˆ ê°ê°ì˜ ì¬ê³ ë³´ë‹¤ ì£¼ë¬¸ëŸ‰ì´ ë§ì€ ì£¼ë¬¸ë“¤
    - select o from Order o where o.orderAmount > ALL (select p.stockAmount from Product p)
- ì–´ë–¤ íŒ€ì´ë“  íŒ€ì— ì†Œì†ëœ íšŒì›
    - select m from Member m where m.team = ANY (select t from Team t)

> JPA ì„œë¸Œ ì¿¼ë¦¬ í•œê³„

- JPAëŠ” WHERE, HAVING ì ˆì—ì„œë§Œ ì„œë¸Œ ì¿¼ë¦¬ ì‚¬ìš© ê°€ëŠ¥
- SELECT ì ˆë„ ê°€ëŠ¥(í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„œ ì§€ì›)
- FROM ì ˆì˜ ì„œë¸Œ ì¿¼ë¦¬ëŠ” í˜„ì¬ JPQLì—ì„œ ë¶ˆê°€ëŠ¥ (í•˜ì´ë²„ë„¤ì´íŠ¸6ë¶€í„°ëŠ” ê°€ëŠ¥)
    - ì¡°ì¸ìœ¼ë¡œ í’€ ìˆ˜ ìˆìœ¼ë©´ í’€ì–´ì„œ í•´ê²°

### JPQL íƒ€ì… í‘œí˜„ê³¼ ê¸°íƒ€ì‹

> JPQL íƒ€ì… í‘œí˜„

- ë¬¸ì: â€˜HELLOâ€™, â€˜Sheâ€™â€™sâ€™
- ìˆ«ì: 10L(Long), 10D(Double), 10F(Float)
- Boolean: TRUE, FALSE
- ENUM: jpabook.MemberType.Admin (íŒ¨í‚¤ì§€ëª… í¬í•¨)
- ì—”í‹°í‹° íƒ€ì…: TYPE(m) = Member (ìƒì† ê´€ê³„ì—ì„œ ì‚¬ìš©)

> JPQL ê¸°íƒ€

- SQLê³¼ ë¬¸ë²•ì´ ê°™ì€ ì‹
- EXISTS, IN
- AND, OR, NOT
- =, >, >=, <, <=, <>
- BETWEEN, LIKE, **IS NULL**

### ì¡°ê±´ì‹(CASE ë“±ë“±)

> **ê¸°ë³¸ CASE ì‹**

```sql
select
	 case when m.age <= 10 then 'í•™ìƒìš”ê¸ˆ'
				 when m.age >= 60 then 'ê²½ë¡œìš”ê¸ˆ'
				 else 'ì¼ë°˜ìš”ê¸ˆ'
	 end
from Member m
```

> **ë‹¨ìˆœ CASE ì‹**

```sql
select
	 case t.name
				 when 'íŒ€A' then 'ì¸ì„¼í‹°ë¸Œ110%'
				 when 'íŒ€B' then 'ì¸ì„¼í‹°ë¸Œ120%'
				 else 'ì¸ì„¼í‹°ë¸Œ105%'
	 end
from Team t
```

- COALESCE - í•˜ë‚˜ì”© ì¡°íšŒí•´ì„œ nullì´ ì•„ë‹ˆë©´ ë°˜í™˜
    
    - ì‚¬ìš©ì ì´ë¦„ì´ ì—†ìœ¼ë©´ ì´ë¦„ ì—†ëŠ” íšŒì›ì„ ë°˜í™˜
    
    ```sql
    select coalesce(m.username,'ì´ë¦„ ì—†ëŠ” íšŒì›') from Member m
    ```
    
- NULLIF - ë‘ ê°’ì´ ê°™ìœ¼ë©´ null ë°˜í™˜, ë‹¤ë¥´ë©´ ì²«ë²ˆì§¸ ê°’ ë°˜í™˜
    
    - ì‚¬ìš©ì ì´ë¦„ì´ â€˜ê´€ë¦¬ìâ€™ë©´ null ë°˜í™˜, ë‚˜ë¨¸ì§€ëŠ” ë³¸ì¸ ì´ë¦„ ë°˜í™˜
    
    ```sql
    select NULLIF(m.username, 'ê´€ë¦¬ì') from Member m
    ```
    

### JPQL í•¨ìˆ˜