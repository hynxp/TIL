### ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V1: ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œ

<aside> ğŸ’¡ **ì‹¤ë¬´ì—ì„œ ì •ë§ ì¤‘ìš”í•œ ë‚´ìš©**

</aside>

```java
/**
 * XToOneê´€ê³„
 * Order
 * Order -> Member @ManyToOne
 * Order -> Delivery @OneToOne
 */
@RestController
@RequiredArgsConstructor
public class OrderSimpleApiController {

    private final OrderRepository orderRepository;

    @GetMapping("/api/v1/simple-orders")
    public List<Order> ordersV1() {

				//select o from Order o join o.member m
        List<Order> all = orderRepository.findAllByString(new OrderSearch());
        return all;
    }
}
```

- order â†’ memberì™€ order â†’ address ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •ë˜ì–´ìˆë‹¤.
- ë”°ë¼ì„œ ì‹¤ì œ ì—”í‹°í‹° ëŒ€ì‹ ì— í”„ë¡ì‹œ ì¡´ì¬
- jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ í”„ë¡ì‹œ ê°ì²´ë¥¼ jsonìœ¼ë¡œ ì–´ë–»ê²Œ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€ ëª¨ë¦„

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2921fa62-9546-4333-8427-c02a06dcd14c/Untitled.png)

â†’ InvalidDefinitionException ë°œìƒ (ByteBuddy~~)

- Hibernate5Moduleì„ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ í•´ê²°ë¨

```java
@Bean
Hibernate5Module hibernate5Module() {
   Hibernate5Module hibernate5Module = new Hibernate5Module();
   return hibernate5Module;
}
```

- ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ, ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ í”„ë¡ì‹œ ê°ì²´ëŠ” ë…¸ì¶œ ì•ˆí•¨
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4583a2e3-068d-4930-bb8c-ab1cfdbea3a3/Untitled.png)
    
- ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•˜ë©´ ê°•ì œë¡œ ì§€ì—° ë¡œë”© ê°€ëŠ¥
    

```java
@Bean
Hibernate5Module hibernate5Module() {
   Hibernate5Module hibernate5Module = new Hibernate5Module();
	 //ê°•ì œ ì§€ì—° ë¡œë”© ì„¤ì •
   hibernate5Module.configure(Hibernate5Module.Feature.FORCE_LAZY_LOADING, true);
   return hibernate5Module;
}
```

- ì´ ì˜µì…˜ì„ í‚¤ë©´ order -> member , member -> orders ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ê³„ì† ë¡œë”©í•˜ê²Œ ëœë‹¤. ë”°ë¼ì„œ @JsonIgnore ì˜µì…˜ì„ í•œê³³ì— ì£¼ì–´ì•¼ í•œë‹¤.
    
- member, orderItems, delivery ì •ë³´ê°€ ê°™ì´ ë‚˜ì˜´
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5f654954-d24a-44d4-bdb1-3e2549915da5/Untitled.png)
    
- ì›í•˜ëŠ” ì—”í‹°í‹° ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê¸°
    

```java
@RestController
@RequiredArgsConstructor
public class OrderSimpleApiController {

    private final OrderRepository orderRepository;

    @GetMapping("/api/v1/simple-orders")
    public List<Order> ordersV1() {
        List<Order> all = orderRepository.findAllByString(new OrderSearch());
        for (Order order : all) {
            order.getMember().getName();    //Lazy ê°•ì œ ì´ˆê¸°í™”
            order.getDelivery().getAddress();    //Lazy ê°•ì œ ì´ˆ ê¸°í™”
        }

        return all;
    }
}
```

- order.getMember() ê¹Œì§€ë§Œ í•˜ë©´ í”„ë¡ì‹œ ê°ì²´ì¸ë° í•„ë“œë¥¼ ê°€ì ¸ì™€ì•¼ í•¨ìœ¼ë¡œ Lazyê°€ ê°•ì œ ì´ˆê¸°í™”ê°€ ë˜ì„œ Memberí…Œì´ë¸”ì— ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ ê°€ì ¸ì˜¤ê²Œ ëœë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5b1b25f9-732d-41f3-94bc-62a0351c9a4d/Untitled.png)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/90092ff1-9e94-4e6d-930d-254e9bd64ba9/Untitled.png)
    

### **ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V2: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜**

ì¿¼ë¦¬ê°€ ì´ 1 + N + Në²ˆ ì‹¤í–‰ëœë‹¤.(v1ê³¼ ì¿¼ë¦¬ìˆ˜ ê²°ê³¼ëŠ” ê°™ë‹¤.)

- order ì¡°íšŒ 1ë²ˆ(order ì¡°íšŒ ê²°ê³¼ ìˆ˜ê°€ Nì´ ëœë‹¤.
- order -> member ì§€ì—° ë¡œë”© ì¡°íšŒ N ë²ˆ
- order -> delivery ì§€ì—° ë¡œë”© ì¡°íšŒ N ë²ˆ
- ì˜ˆ) orderì˜ ê²°ê³¼ê°€ 4ê°œë©´ 1 + 4 + 4ë²ˆ ì‹¤í–‰ëœë‹¤.(ìµœì•…ì˜ ê²½ìš°)
    - ì§€ì—°ë¡œë”©ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•˜ë¯€ë¡œ, ì´ë¯¸ ì¡°íšŒëœ ê²½ìš° ì¿¼ë¦¬ë¥¼ ìƒëµí•œë‹¤.

```java
/**
 * V2. ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ DTOë¡œ ë³€í™˜(fetch join ì‚¬ìš©X)
 * - ë‹¨ì : ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì¿¼ë¦¬ Në²ˆ í˜¸ì¶œ
 */
@GetMapping("/api/v2/simple-orders")
public List<SimpleOrderDto> ordersV2() {
    List<Order> orders = orderRepository.findAllByString(new OrderSearch());

    List<SimpleOrderDto> result = orders.stream()
            .map(o -> new SimpleOrderDto(o))
            .collect(Collectors.toList());

    return result;
}

@Data
static class SimpleOrderDto {
    private Long orderId;
    private String name;
    private LocalDateTime orderDate;
    private OrderStatus orderStatus;
    private Address address;

    public SimpleOrderDto(Order order) {
        orderId = order.getId();
        name = order.getMember().getName();
        orderDate = order.getOrderDate();
        orderStatus = order.getStatus();
        address = order.getDelivery().getAddress();
    }
}
```

```
1.
select
        order0_.order_id as order_id1_6_,
        order0_.delivery_id as delivery4_6_,
        order0_.member_id as member_i5_6_,
        order0_.order_date as order_da2_6_,
        order0_.status as status3_6_ 
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id limit ?
2.
    select
        member0_.member_id as member_i1_4_0_,
        member0_.city as city2_4_0_,
        member0_.street as street3_4_0_,
        member0_.zipcode as zipcode4_4_0_,
        member0_.name as name5_4_0_ 
    from
        member member0_ 
    where
        member0_.member_id=?
3.
        delivery0_.delivery_id as delivery1_2_0_,
        delivery0_.city as city2_2_0_,
        delivery0_.street as street3_2_0_,
        delivery0_.zipcode as zipcode4_2_0_,
        delivery0_.status as status5_2_0_ 
    from
        delivery delivery0_ 
    where
        delivery0_.delivery_id=?
4.
    select
        member0_.member_id as member_i1_4_0_,
        member0_.city as city2_4_0_,
        member0_.street as street3_4_0_,
        member0_.zipcode as zipcode4_4_0_,
        member0_.name as name5_4_0_ 
    from
        member member0_ 
    where
        member0_.member_id=?
5. 
    select
        delivery0_.delivery_id as delivery1_2_0_,
        delivery0_.city as city2_2_0_,
        delivery0_.street as street3_2_0_,
        delivery0_.zipcode as zipcode4_2_0_,
        delivery0_.status as status5_2_0_ 
    from
        delivery delivery0_ 
    where
        delivery0_.delivery_id=?
```

ì¿¼ë¦¬ê°€ ì´ 5ë²ˆ ë‚˜ê°(Orderê°€ 2ê±´ì´ê¸° ë•Œë¬¸ì— SimpleOrderDto()ê°€ 2ë°”í€´ ë”)

- 1 select order â†’ `List<Order> orders = orderRepository.findAllByString(new OrderSearch());`
- 2,4 select member â†’ `SimpleOrderDto() -``name = order.getMember().getName();`
- 3,5 select delivery â†’ `SimpleOrderDto() -``address =order.getDelivery().getAddress();`

### **ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V3: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ - í˜ì¹˜ ì¡°ì¸ ìµœì í™”**

ì—”í‹°í‹°ë¥¼ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬ 1ë²ˆì— ì¡°íšŒí•œë‹¤.

```java
@GetMapping("/api/v3/simple-orders")
    public List<SimpleOrderDto> ordersV3() {
        List<Order> orders = orderRepository.findAllWithMemberDelivery();
        List<SimpleOrderDto> result = orders.stream()
                .map(order -> new SimpleOrderDto(order))
                .collect(Collectors.toList());

        return result;
    }
```

```java
public List<Order> findAllWithMemberDelivery() {
    return em.createQuery(
            "select o from Order o" +
                    " join fetch o.member m" +
                    " join fetch o.delivery d", Order.class
    ).getResultList();
}
```

```
select
        order0_.order_id as order_id1_6_0_,
        member1_.member_id as member_i1_4_1_,
        delivery2_.delivery_id as delivery1_2_2_,
        order0_.delivery_id as delivery4_6_0_,
        order0_.member_id as member_i5_6_0_,
        order0_.order_date as order_da2_6_0_,
        order0_.status as status3_6_0_,
        member1_.city as city2_4_1_,
        member1_.street as street3_4_1_,
        member1_.zipcode as zipcode4_4_1_,
        member1_.name as name5_4_1_,
        delivery2_.city as city2_2_2_,
        delivery2_.street as street3_2_2_,
        delivery2_.zipcode as zipcode4_2_2_,
        delivery2_.status as status5_2_2_ 
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id
```

### ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V4: JPAì—ì„œ DTOë¡œ ë°”ë¡œ ì¡°íšŒ