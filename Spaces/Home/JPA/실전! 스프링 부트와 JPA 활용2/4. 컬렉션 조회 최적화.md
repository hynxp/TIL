### ì£¼ë¬¸ ì¡°íšŒ V1: ì—”í‹°í‹° ì§ì ‘ ë…¸ì¶œ

ì£¼ë¬¸ ë‚´ì—­ì—ì„œ ì£¼ë¬¸í•œ ìƒí’ˆ ì •ë³´(orderItems)ë¥¼ ì¶”ê°€ë¡œ ì¡°íšŒí•´ë³´ì.

Order ê¸°ì¤€ìœ¼ë¡œ ì»¬ë ‰ì…˜ì¸ OrderItemê³¼ Itemì´ í•„ìš”í•˜ë‹¤.

ì•ì˜ ì˜ˆì œì—ì„œëŠ” toOne(OneToOne, ManyToOne) ê´€ê³„ë§Œ ìˆì—ˆë‹¤. ì´ë²ˆì—ëŠ” ì»¬ë ‰ì…˜ì¸ ì¼ëŒ€ë‹¤ ê´€ê³„ (OneToMany)ë¥¼ ì¡°íšŒí•˜ê³ , ìµœì í™”í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì

```java
/**
 * V1.ì—”í‹°í‹° ì§ì ‘ ë…¸ì¶œ
* - Hibernate5Moduleëª¨ë“ˆ ë“±ë¡, LAZY=nullì²˜ë¦¬
* -ì–‘ë°©í–¥ ê´€ê³„ ë¬¸ì œ ë°œìƒ-> @JsonIgnore
 */
@GetMapping("/api/v1/orders")
public List<Order> ordersV1() {
    List<Order> all = orderRepository.findAllByString(new OrderSearch());

    for (Order order : all) {
        order.getMember().getName();    //Lazy ê°•ì œ ì´ˆê¸°í™”
        order.getDelivery().getAddress();   //Lazy ê°•ì œ ì´ˆê¸°í™”

        //hibernate5Module ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì¸í•´ í”„ë¡ì‹œì¸ ë°ì´í„°ë“¤ì€ ì•ˆë¿Œë ¤ì„œ 
				//í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•´ì¤˜ì•¼ í…Œì´ë¸”ì„ ì¡°íšŒí•¨
        List<OrderItem> orderItems = order.getOrderItems();
        orderItems.stream().forEach(o -> o.getItem().getName()); //Lazy ê°•ì œ ì´ˆê¸°í™”
    }
    return all;
}
```

```java
public List<Order> findAllByString(OrderSearch orderSearch) {
    String jpql = "select o from Order o join o.member m";
    boolean isFirstCondition = true;

    //ì£¼ë¬¸ ìƒíƒœ ê²€ìƒ‰
    if (orderSearch.getOrderStatus() != null) {
        if (isFirstCondition) {
            jpql += " where";
            isFirstCondition = false;
        } else {
            jpql += " and";
        }
        jpql += " o.status = :status";
    }

    //íšŒì› ì´ë¦„ ê²€ìƒ‰
    if (StringUtils.hasText(orderSearch.getMemberName())) {
        if (isFirstCondition) {
            jpql += " where";
            isFirstCondition = false;
        } else {
            jpql += " and";
        }
        jpql += " m.name like :name";
    }

    TypedQuery<Order> query = em.createQuery(jpql, Order.class)
            .setMaxResults(1000);//ìµœëŒ€ 1000ê±´ê¹Œì§€ ì¡°íšŒ

    if (orderSearch.getOrderStatus() != null) {
        query = query.setParameter("status", orderSearch.getOrderStatus());
    }
    if (StringUtils.hasText(orderSearch.getMemberName())) {
        query = query.setParameter("name", orderSearch.getMemberName());
    }

    return query.getResultList();
}
```

- orderItem , item ê´€ê³„ë¥¼ ì§ì ‘ ì´ˆê¸°í™”í•˜ë©´ Hibernate5Module ì„¤ì •ì— ì˜í•´ ì—”í‹°í‹°ë¥¼ JSONìœ¼ë¡œ ìƒì„±í•œë‹¤.
- ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì¼ ì‹œ ë¬´í•œ ë£¨í”„ì— ê±¸ë¦¬ì§€ ì•Šê²Œ í•œê³³ì— @JsonIgnoreë¥¼ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.
- **ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤.**

### ì£¼ë¬¸ ì¡°íšŒ V2: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜

```java
@GetMapping("/api/v2/orders")
public List<OrderDto> ordersV2() {
    List<Order> orders = orderRepository.findAllByString(new OrderSearch());
    List<OrderDto> collect = orders.stream()
            .map(o -> new OrderDto(o))
            .collect(Collectors.toList());

    return collect;
}

@Getter
static class OrderDto {

    private Long orderId;
    private String name;
    private LocalDateTime orderDate;
    private OrderStatus orderStatus;
    private Address address;
    private List<OrderItem> orderItems;

    public OrderDto(Order order) {
        orderId = order.getId();
        name = order.getMember().getName();
        orderDate = order.getOrderDate();
        orderStatus = order.getStatus();
        address = order.getDelivery().getAddress();
        order.getOrderItems().stream().forEach(o -> o.getItem().getName());
        orderItems = order.getOrderItems();
    }
}
```

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9e065abd-a5dc-4299-8127-83c376fbeee5/Untitled.png)

ë°˜í™˜ì€ DTOë¡œ í•˜ì§€ë§Œ ì—¬ì „íˆ orderItemì˜ ìŠ¤í™ì´ ê·¸ëŒ€ë¡œ ë…¸ì¶œëœë‹¤.

ë¦¬í„´íƒ€ì…ì— ì—”í‹°í‹°ê°€ ë“¤ì–´ê°€ë©´ ì•ˆë¨! ì´ì¡°ì°¨ dtoë¡œ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.

orderItem ìŠ¤í™ ë°”ë€Œê²Œ ë˜ë©´ í™”ë©´ì´ ë‹¤ ë°”ë€œ ã… 

```java
@Getter
static class OrderDto {
		.
		.
    private List<**OrderItemDto**> orderItems;

    public OrderDto(Order order) {
		    .
				.
        orderItems = order.getOrderItems().stream()
                        .map(orderItem -> new OrderItemDto(orderItem))
                        .collect(Collectors.toList());
    }
}

@Getter
static class OrderItemDto {
    private String itemName;    //ìƒí’ˆëª…
    private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
    private int count;  //ì£¼ë¬¸ ìˆ˜ëŸ‰

    public OrderItemDto(OrderItem orderItem) {
        itemName = orderItem.getItem().getName();
        orderPrice = orderItem.getOrderPrice();
        count = orderItem.getCount();
    }
}
```

orderItemë„ dtoë¡œ ë³€ê²½í•´ì¤€ë‹¤.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/886fb8eb-435c-4148-be72-87b0da7a5c97/Untitled.png)

orderItemsì˜ ì›í•˜ëŠ” ë°ì´í„°ë§Œ ë½‘ì„ ìˆ˜ ìˆìŒ

í•˜ì§€ë§Œ LAZY ë¡œë”©ë•Œë¬¸ì— ì—„ì²­ ë§ì€ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤.

SELECT ORDER â†’ ì£¼ë¬¸ì´ 2ê°œ ì´ë¯€ë¡œ 2ê±´ì´ ì¡°íšŒë¨

ì£¼ë¬¸ Nê°œì— ëŒ€í•´ ì•„ë˜ ìˆœì„œê°€ Në²ˆ ë°˜ë³µëœë‹¤.

SELECT MEMBER â†’ SELECT DELIVERY â†’ SELECT ORDER ITEM â†’ SELECT ITEM(ì•„ì´í…œ Nê°œë©´ Nê±´ ì¡°íšŒ)

- SQL ì‹¤í–‰ ìˆ˜
    - order 1ë²ˆ
    - member , address Në²ˆ(order ì¡°íšŒ ìˆ˜ ë§Œí¼)
    - orderItem Në²ˆ(order ì¡°íšŒ ìˆ˜ ë§Œí¼)
    - item Në²ˆ(orderItem ì¡°íšŒ ìˆ˜ ë§Œí¼)

### ì£¼ë¬¸ ì¡°íšŒ V3: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ - í˜ì¹˜ ì¡°ì¸ ìµœì í™”

```java
@GetMapping("/api/v3/orders")
public List<OrderDto> ordersV3() {
    List<Order> orders = orderRepository.findAllWithItem();

    List<OrderDto> result = orders.stream()
            .map(o -> new OrderDto(o))
            .collect(Collectors.toList());

    return result;
}
```

```java
public List<Order> findAllWithItem() {
    return em.createQuery(
                "select o from Order o" +
                        " join fetch o.member m" +
                        " join fetch o.delivery d" +
                        " join fetch o.orderItems oi" +
                        " join fetch oi.item i", Order.class)
            .getResultList();
}
```

í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ SQLì´ 1ë²ˆë§Œ ì‹¤í–‰ëœë‹¤.

í•˜ì§€ë§Œ ì•„ë˜ì²˜ëŸ¼ ì¼ëŒ€ë‹¤ ì¡°ì¸ì´ ë˜ì–´ orderê°€ 2ê°œê³  1ê°œë‹¹ orderItem 2ê°œë©´ ë»¥íŠ€ê¸°ë˜ì„œ 4rowë¡œ ë‚˜ì˜¨ë‹¤.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bcafc3ef-45f5-454a-873b-7d9cb5ff5cc4/Untitled.png)

```
select
        distinct order0_.order_id as order_id1_6_0_,
        member1_.member_id as member_i1_4_1_,
        delivery2_.delivery_id as delivery1_2_2_,
        orderitems3_.order_item_id as order_it1_5_3_,
        item4_.item_id as item_id2_3_4_,
        order0_.delivery_id as delivery4_6_0_,
        . //ì´í•˜ orderì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        member1_.city as city2_4_1_,
        . //ì´í•˜ memberì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        delivery2_.city as city2_2_2_,
        . //ì´í•˜ deliveryì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        orderitems3_.count as count2_5_3_,
        . //ì´í•˜ orderitemsì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        orderitems3_.order_item_id as order_it1_5_0__,
        item4_.name as name3_3_4_,
        . //ì´í•˜ itemì˜ ëª¨ë“  ì»¬ëŸ¼
				.
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id 
    inner join
        order_item orderitems3_ 
            on order0_.order_id=orderitems3_.order_id 
    inner join
        item item4_ 
            on orderitems3_.item_id=item4_.item_id
```

```java
public List<Order> findAllWithItem() {
    return em.createQuery(
                "select **distinct** o from Order o" +
                        " join fetch o.member m" +
                        " join fetch o.delivery d" +
                        " join fetch o.orderItems oi" +
                        " join fetch oi.item i", Order.class)
            .getResultList();
}
```

ê·¸ë˜ì„œ distinct í‚¤ì›Œë“œ ì¶”ê°€í•œë‹¤. ê·¸ë˜ë„ dbì—ì„  1rowê°€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ë˜ì„œ ì¿¼ë¦¬ ì¡°íšŒí•˜ë©´ ë˜‘ê°™ì´ 4rowë¡œ ë‚˜ì˜¨ë‹¤.

jpaì—ì„œ ìì²´ì ìœ¼ë¡œ ì œê±°í•´ì£¼ëŠ” ê²ƒì´ë‹¤.

2ê°€ì§€ ê¸°ëŠ¥

- dbì— distinctë¥¼ ë‚ ë ¤ì¤€ë‹¤.
- ë£¨íŠ¸ë¼ê³  í‘œí˜„í•˜ëŠ”ë° from - ì—”í‹°í‹°ê°€ ì¤‘ë³µì´ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¤‘ë³µì„ ê±¸ëŸ¬ì¤€ë‹¤.

```java
public List<Order> findAllWithItem() {
    return em.createQuery(
                "select distinct o from Order o" +
                        " join fetch o.member m" +
                        " join fetch o.delivery d" +
                        " join fetch o.orderItems oi" +
                        " join fetch oi.item i", Order.class)
            .setFirstResult(1)  //ì¶”ê°€
            .setMaxResults(100) //ì¶”ê°€
            .getResultList();
}
```

```
WARN 10876 ---: HHH000104: firstResult/maxResults specified with collection fetch; applying in memory!
```

í˜ì´ì§• ë¶ˆê°€ëŠ¥

- ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
- ê²½ê³  ë¡œê·¸ë¥¼ ë‚¨ê¸°ë©´ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ DBì—ì„œ ì½ì–´ì˜¤ê³ , ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§• í•´ë²„ë¦°ë‹¤(ë§¤ìš° ìœ„í—˜í•¨)
- ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì€ 1ê°œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì»¬ë ‰ì…˜ ë‘˜ ì´ìƒì— í˜ì¹˜ ì¡°ì¸ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ(ì•„ì§ ì´í•´ì•ˆë¨)

### ì£¼ë¬¸ ì¡°íšŒ V3.1: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ - í˜ì´ì§•ê³¼ í•œê³„ ëŒíŒŒ

- ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ì¡°ì¸í•˜ë©´ í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤(v3 ì°¸ê³ )
    - ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ì¡°ì¸í•˜ë©´ ì¼ëŒ€ë‹¤ ì¡°ì¸ì´ ë°œìƒí•˜ì—¬ ë°ì´í„°ê°€ ì˜ˆì¸¡í•  ìˆ˜ ì—†ì´ ì¦ê°€í•œë‹¤.
    - ì¼ëŒ€ë‹¤ì—ì„œ ì¼(1)ì„ ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§•ì„ í•˜ëŠ” ê²ƒì´ ëª©ì ì¸ë°, ë°ì´í„°ëŠ” ë‹¤(N)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ rowê°€ ë»¥íŠ€ê¸° ëœë‹¤. ex) ì£¼ë¬¸ì´ 100ê±´ì´ë©´ 5ê±´ë§Œ ë³´ì—¬ì£¼ê³  ì‹¶ì„ ë•Œ ì£¼ë¬¸ì— ëŒ€í•œ ì•„ì´í…œì„ ê¸°ì¤€ìœ¼ë¡œ rowê°€ returnëœë‹¤.
    - orderë¥¼ ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§•ì„ í•˜ê³  ì‹¶ì€ë°, ë‹¤(N)ì¸ OrderItemì„ ì¡°ì¸í•˜ë©´ OrderItemì´ ê¸°ì¤€ì´ ë˜ì–´ë²„ë¦°ë‹¤.

**í•œê³„ ëŒíŒŒ**

ê·¸ë ‡ë‹¤ë©´ í˜ì´ì§• + ì»¬ë ‰ì…˜ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ê³  ì‹¶ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í•˜ë‚˜

- ë¨¼ì € **ToOne**(OneToOne, ManyToOne) ê´€ê³„ë¥¼ ëª¨ë‘ **í˜ì¹˜ì¡°ì¸** í•œë‹¤. ToOne ê´€ê³„ëŠ” rowìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ì§€ ì•Šìœ¼ë¯€ë¡œ í˜ì´ì§• ì¿¼ë¦¬ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.
- **ì»¬ë ‰ì…˜**ì€ **ì§€ì—° ë¡œë”©**ìœ¼ë¡œ ì¡°íšŒí•œë‹¤.

```java
@GetMapping("/api/v3.1/orders")
public List<OrderDto> ordersV3_page(
										@RequestParam(value = "offset", defaultValue = "0") int offset,
                    @RequestParam(value = "limit", defaultValue = "100") int limit) {
    List<Order> orders = orderRepository.findAllWithMemberDelivery(offset, limit);

    List<OrderDto> result = orders.stream()
            .map(o -> new OrderDto(o))
            .collect(Collectors.toList());

    return result;
}
```

```java
public List<Order> findAllWithMemberDelivery(int offset, int limit) {
    return em.createQuery(
            "select o from Order o" +
                    " **join fetch o.member m**" +
                    " **join fetch o.delivery d**", Order.class)
            .setFirstResult(offset)
            .setMaxResults(limit)
            .getResultList();
}
```

```
select
        order0_.order_id as order_id1_6_0_,
        member1_.member_id as member_i1_4_1_,
        delivery2_.delivery_id as delivery1_2_2_,
        order0_.delivery_id as delivery4_6_0_,
        . //ì´í•˜ orderì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        member1_.city as city2_4_1_,
        . //ì´í•˜ memberì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        delivery2_.city as city2_2_2_,
        . //ì´í•˜ deliveryì˜ ëª¨ë“  ì»¬ëŸ¼
				.
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id limit ?
--------------------------------------------------------------------------- 
    select
        orderitems0_.order_id as order_id5_5_0_,
        .
				.
    from
        order_item orderitems0_ 
    where
        orderitems0_.order_id=?
---------------------------------------------------------------------------                       : 
    select
        item0_.item_id as item_id2_3_0_,
        .
				.
    from
        item item0_ 
    where
        item0_.item_id=?
---------------------------------------------------------------------------                       : 
    select
        item0_.item_id as item_id2_3_0_,
        .
				.
    from
        item item0_ 
    where
        item0_.item_id=?
---------------------------------------------------------------------------                       : 
    select
        orderitems0_.order_id as order_id5_5_0_,
        .
				.
    from
        order_item orderitems0_ 
    where
        orderitems0_.order_id=?
---------------------------------------------------------------------------                     : 
    select
        item0_.item_id as item_id2_3_0_,
        .
				.
    from
        item item0_ 
    where
        item0_.item_id=?
---------------------------------------------------------------------------                       : 
    select
        item0_.item_id as item_id2_3_0_,
        .
				.
    from
        item item0_ 
    where
        item0_.item_id=?
```

ì¿¼ë¦¬ë¥¼ ë³´ë©´ order, member, delivery ë°ì´í„°ëŠ” í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ í•œë²ˆì— ì¡°íšŒëê³ 

orderItemì— ëŒ€í•œ ë°ì´í„°ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ Në²ˆ ì¿¼ë¦¬ê°€ ë‚ ì•„ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì–´ì°¨í”¼ order_idì´ ê°™ì€ orderItemì„ ê°ê° selectí•´ì„œ ê°€ì ¸ì˜¤ëŠ” ê±´ ë„ˆë¬´ ë¹„íš¨ìœ¨ì ì´ë‹¤.

Në²ˆ ì¿¼ë¦¬ë¥¼ ì¤„ì¼ ìˆ˜ ì—†ì„ê¹Œ?

ì§€ì—° ë¡œë”© ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ë‘ ê°€ì§€ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

- `hibernate.default_batch_fetch_size: 100`
    
    ```xml
    spring:
    	 jpa:
    		 properties:
    			 hibernate:
    				 default_batch_fetch_size: 1000
    ```
    
- @BatchSize : ê°œë³„ ìµœì í™”
    
    - ì»¬ë ‰ì…˜ì€ ì»¬ë ‰ì…˜ í•„ë“œì—, ì—”í‹°í‹°ëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ì— ì ìš©(ex: OrderItemì˜ item)
        
        ```java
        @BatchSize(size = 100)
        public abstract class Item {
        }
        ```
        

```
select
        order0_.order_id as order_id1_6_0_,
        member1_.member_id as member_i1_4_1_,
        delivery2_.delivery_id as delivery1_2_2_,
        order0_.delivery_id as delivery4_6_0_,
        . //ì´í•˜ orderì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        member1_.city as city2_4_1_,
        . //ì´í•˜ memberì˜ ëª¨ë“  ì»¬ëŸ¼
				.
        delivery2_.city as city2_2_2_,
        . //ì´í•˜ deliveryì˜ ëª¨ë“  ì»¬ëŸ¼
				.
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id limit ?
---------------------------------------------------------------------------                      : 
    select
        orderitems0_.order_id as order_id5_5_1_,
        .
				.
    from
        order_item orderitems0_ 
    where
        orderitems0_.order_id in (
            ?, ?
        )
---------------------------------------------------------------------------                       : 
    select
        item0_.item_id as item_id2_3_0_,
        .
				.
    from
        item item0_ 
    where
        item0_.item_id in (
            ?, ?, ?, ?
        )
```

orderItemsì„ Në²ˆ SELECT ì¡°íšŒí–ˆì—ˆëŠ”ë° in ì¿¼ë¦¬ë¡œ í•œë²ˆì— ë‹¤ ê°–ê³ ì™€ì¤€ë‹¤.

- ì¥ì 
    - ì¿¼ë¦¬ í˜¸ì¶œ ìˆ˜ê°€ 1 + N â†’ 1 + 1ë¡œ ìµœì í™” ëœë‹¤.
    - ì¡°ì¸ë³´ë‹¤ DB ë°ì´í„° ì „ì†¡ëŸ‰ì´ ìµœì í™” ëœë‹¤. (Orderì™€ OrderItemì„ ì¡°ì¸í•˜ë©´ Orderê°€ OrderItem ë§Œí¼ ì¤‘ë³µí•´ì„œ ì¡°íšŒëœë‹¤. ì´ ë°©ë²•ì€ ê°ê° ì¡°íšŒí•˜ë¯€ë¡œ ì „ì†¡í•´ì•¼í•  ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ë‹¤.)
    - í˜ì¹˜ ì¡°ì¸ ë°©ì‹ê³¼ ë¹„êµí•´ì„œ ì¿¼ë¦¬ í˜¸ì¶œ ìˆ˜ê°€ ì•½ê°„ ì¦ê°€í•˜ì§€ë§Œ, DB ë°ì´í„° ì „ì†¡ëŸ‰ì´ ê°ì†Œí•œë‹¤.
    - ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì€ í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥ í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ í˜ì´ì§•ì´ ê°€ëŠ¥í•˜ë‹¤.
- ê²°ë¡ 
    - ToOne ê´€ê³„ëŠ” í˜ì¹˜ ì¡°ì¸í•´ë„ í˜ì´ì§•ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ToOne ê´€ê³„ëŠ” í˜ì¹˜ì¡°ì¸ìœ¼ë¡œ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì´ê³  í•´ê²°í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” hibernate.default_batch_fetch_size ë¡œ ìµœì í™” í•˜ì.

> BatchSizeì˜ ì ë‹¹í•œ size í¬ê¸°?

sizeëŠ” in ì¿¼ë¦¬ì˜ ê°œìˆ˜ë¥¼ ë§í•œë‹¤. 10ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ë°ì´í„° 100ê±´ì— ëŒ€í•´ in ì¿¼ë¦¬ê°€ 10ë²ˆ ë‚ ì•„ê°„ë‹¤.

v3.1 ê¹Œì§€ë§Œ í•´ë„ jpaì˜ ì„±ëŠ¥ ìµœì í™”ëŠ” 90í¼ê°€ ëœ ê±°ë¼ê³  í•  ìˆ˜ ìˆë‹¤.

<aside> ğŸ’¡ ì°¸ê³ 

</aside>

default_batch_fetch_size ì˜ í¬ê¸°ëŠ” ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¥¼ ê³¨ë¼ì•¼ í•˜ëŠ”ë°,

100~1000 ì‚¬ì´ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤. ì´ ì „ëµì„ SQL IN ì ˆì„ ì‚¬ìš©í•˜ëŠ”ë°,

ë°ì´í„°ë² ì´ìŠ¤ì— ë”°ë¼ IN ì ˆ íŒŒë¼ë¯¸í„°ë¥¼1000ìœ¼ë¡œ ì œí•œí•˜ê¸°ë„ í•œë‹¤.

1000ìœ¼ë¡œ ì¡ìœ¼ë©´ í•œë²ˆì— 1000ê°œë¥¼ DBì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¶ˆëŸ¬ì˜¤ë¯€ë¡œ DBì— ìˆœê°„ ë¶€í•˜ê°€ ì¦ê°€í•  ìˆ˜ ìˆë‹¤.

í•˜ì§€ë§Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ 100ì´ë“  1000ì´ë“  ê²°êµ­ ì „ì²´ ë°ì´í„°ë¥¼ ë¡œë”©í•´ì•¼í•˜ë¯€ë¡œ

ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ê°™ë‹¤. 1000ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒ ê°€ì¥ ì¢‹ì§€ë§Œ,

ê²°êµ­ DBë“  ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë“  ìˆœê°„ ë¶€í•˜ë¥¼ ì–´ë””ê¹Œì§€ ê²¬ë”œ ìˆ˜ ìˆëŠ”ì§€ë¡œ ê²°ì •í•˜ë©´ ëœë‹¤

### ì£¼ë¬¸ ì¡°íšŒ V4: JPAì—ì„œ DTO ì§ì ‘ ì¡°íšŒ

```java
@GetMapping("/api/v4/orders")
public List<OrderQueryDto> ordersV4() {
	 return orderQueryRepository.findOrderQueryDtos();
}
```

```java
/**
* ì»¬ë ‰ì…˜ì€ ë³„ë„ë¡œ ì¡°íšŒ
* Query:ë£¨íŠ¸1ë²ˆ,ì»¬ë ‰ì…˜Në²ˆ
* ë‹¨ê±´ ì¡°íšŒì—ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
*/
public List<OrderQueryDto> findOrderQueryDtos() {
    //ë£¨íŠ¸(order) ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
    List<OrderQueryDto> result = findOrders();

    //ì»¬ë ‰ì…˜(orderItems) ì¡°íšŒ
    result.forEach(o -> {
        List<OrderItemQueryDto> orderItems = findOrderItems(o.getOrderId());
        o.setOrderItems(orderItems);
    });

    return result;
}

/**
* 1:Nê´€ê³„(ì»¬ë ‰ì…˜)ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ í•œë²ˆì— ì¡°íšŒ
*/
private List<OrderQueryDto> findOrders() {
    return em.createQuery(
                    "select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address)" +
                            " from Order o" +
                            " join o.member m" +
                            " join o.delivery d", OrderQueryDto.class)
            .getResultList();
}

/**
* 1:Nê´€ê³„ì¸ orderItemsì¡°íšŒ
*/
private List<OrderItemQueryDto> findOrderItems(Long orderId) {
    return em.createQuery(
                    "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                            " from OrderItem oi" +
                            " join oi.item i" +
                            " where oi.order.id = :orderId", OrderItemQueryDto.class)
            .setParameter("orderId", orderId)
            .getResultList();
}
```

### ì£¼ë¬¸ ì¡°íšŒ V5: JPAì—ì„œ DTO ì§ì ‘ ì¡°íšŒ - ì»¬ë ‰ì…˜ ì¡°íšŒ ìµœì í™”

```java
@GetMapping("/api/v5/orders")
public List<OrderQueryDto> ordersV5() {
    return orderQueryRepository.findAllByDto_optimization();

}
```

```java
/**
* ì»¬ë ‰ì…˜ì€ ë³„ë„ë¡œ ì¡°íšŒ
* Query:ë£¨íŠ¸1ë²ˆ,ì»¬ë ‰ì…˜Në²ˆ
* ë‹¨ê±´ ì¡°íšŒì—ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
*/
public List<OrderQueryDto> findOrderQueryDtos() {
    //ë£¨íŠ¸(order) ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
    List<OrderQueryDto> result = findOrders();

    //ì»¬ë ‰ì…˜(orderItems) ì¡°íšŒ
    result.forEach(o -> {
        List<OrderItemQueryDto> orderItems = findOrderItems(o.getOrderId());
        o.setOrderItems(orderItems);
    });

    return result;
}

/**
* 1:Nê´€ê³„(ì»¬ë ‰ì…˜)ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ í•œë²ˆì— ì¡°íšŒ
*/
private List<OrderQueryDto> findOrders() {
    return em.createQuery(
                    "select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address)" +
                            " from Order o" +
                            " join o.member m" +
                            " join o.delivery d", OrderQueryDto.class)
            .getResultList();
}

/**
* 1:Nê´€ê³„ì¸orderItemsì¡°íšŒ
*/
private List<OrderItemQueryDto> findOrderItems(Long orderId) {
    return em.createQuery(
                    "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                            " from OrderItem oi" +
                            " join oi.item i" +
                            " where oi.order.id = :orderId", OrderItemQueryDto.class)
            .setParameter("orderId", orderId)
            .getResultList();
}

public List<OrderQueryDto> findAllByDto_optimization() {
    List<OrderQueryDto> result = findOrders();

    //ë£¨í”„ ëŒë©´ì„œ ì£¼ë¬¸ë²ˆí˜¸ ë½‘ê¸° = 2ê°œ
    List<OrderItemQueryDto> orderItems = findOrderItemMap(result);

    //í‚¤ê°€ orderIdì¸ mapìœ¼ë¡œ ë°”ê¿ˆ
    Map<Long, List<OrderItemQueryDto>> orderItemMap = orderItems.stream()
            .collect(Collectors.groupingBy(orderItemQueryDto -> orderItemQueryDto.getOrderId()));

    //ë£¨í”„ë¥¼ ëŒë¦¬ë©´ì„œ orderItems set
    result.forEach(o -> o.setOrderItems(orderItemMap.get(o.getOrderId())));

    return result;

}

private List<OrderItemQueryDto> findOrderItemMap(List<OrderQueryDto> result) {
    List<Long> orderIds = toOrderIds(result);

    List<OrderItemQueryDto> orderItems = em.createQuery(
                    "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                            " from OrderItem oi" +
                            " join oi.item i" +
                            " where oi.order.id in :orderIds", OrderItemQueryDto.class)
            .setParameter("orderIds", orderIds)
            .getResultList();
    return orderItems;
}

private List<Long> toOrderIds(List<OrderQueryDto> result) {
    return result.stream()
            .map(o -> o.getOrderId())
            .collect(Collectors.toList());
}
```

```java
select
        order0_.order_id as col_0_0_,
        member1_.name as col_1_0_,
        order0_.order_date as col_2_0_,
        order0_.status as col_3_0_,
        delivery2_.city as col_4_0_,
        delivery2_.street as col_4_1_,
        delivery2_.zipcode as col_4_2_ 
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id
-------------------------------------------------------------------
    select
        orderitem0_.order_id as col_0_0_,
        item1_.name as col_1_0_,
        orderitem0_.order_price as col_2_0_,
        orderitem0_.count as col_3_0_ 
    from
        order_item orderitem0_ 
    inner join
        item item1_ 
            on orderitem0_.item_id=item1_.item_id 
    where
        orderitem0_.order_id in (
            ? , ?
        )
```

```json
[
    {
        "orderId": 4,
        "name": "userA",
        "orderDate": "2023-06-26T15:39:05.259955",
        "orderStatus": "ORDER",
        "address": {
            "city": "ì„œìš¸",
            "street": "1",
            "zipcode": "11111"
        },
        "orderItems": [
            {
                "itemName": "SPRING1 BOOK",
                "orderPrice": 10000,
                "count": 1
            },
            {
                "itemName": "SPRING2 BOOK",
                "orderPrice": 20000,
                "count": 2
            }
        ]
    },
    {
        "orderId": 11,
        "name": "userB",
        "orderDate": "2023-06-26T15:39:05.314339",
        "orderStatus": "ORDER",
        "address": {
            "city": "ëŒ€êµ¬",
            "street": "2",
            "zipcode": "22222"
        },
        "orderItems": [
            {
                "itemName": "SPRING1 BOOK",
                "orderPrice": 20000,
                "count": 3
            },
            {
                "itemName": "SPRING2 BOOK",
                "orderPrice": 40000,
                "count": 4
            }
        ]
    }
]
```

### ì£¼ë¬¸ ì¡°íšŒ V6: JPAì—ì„œ DTOë¡œ ì§ì ‘ ì¡°íšŒ, í”Œë« ë°ì´í„° ìµœì í™”