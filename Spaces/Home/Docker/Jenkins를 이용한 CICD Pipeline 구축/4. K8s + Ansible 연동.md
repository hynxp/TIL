## ë°°í¬ ë°©ì‹ ë¹„êµ - ê¸°ë³¸ vs VM vs Container
![[sec4_1.png]]
## ê¸°ë³¸ ëª…ë ¹ì–´
### ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì¡°íšŒ
`kubectl get all`
### ë…¸ë“œ í™•ì¸Â Â 
`kubectl get nodes`
ì´ ëª…ë ¹ì€ Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ëª¨ë“  ë…¸ë“œë“¤ì„ ë‚˜ì—´í•˜ê³  ê° ë…¸ë“œì˜ ìƒíƒœì™€ ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.
### pods í™•ì¸
`kubectl get pods`
í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  Podë“¤ì˜ ëª©ë¡ì„ í‘œì‹œí•œë‹¤.
### deployments í™•ì¸
`kubectl get deployments`
í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  Deploymentsì˜ ëª©ë¡ì„ í‘œì‹œí•œë‹¤.
### ì„œë¹„ìŠ¤ í™•ì¸Â 
`kubectl get services`
í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì •ì˜ëœ ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ëª©ë¡ì„ í‘œì‹œí•œë‹¤.
### Nginx ì„œë²„ ì‹¤í–‰Â 
`kubectl run sample-nginx --image=nginx --port=80`
Nginx Docker ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ `sample-nginx`ë¼ëŠ” ì´ë¦„ì˜ Podë¥¼ ìƒì„±í•˜ê³  80ë²ˆ í¬íŠ¸ë¡œ ë…¸ì¶œì‹œí‚¨ë‹¤.
### ì»¨í…Œì´ë„ˆ ì •ë³´ í™•ì¸Â 
`kubectl describe pod/sample-nginx`
### pods ì‚­ì œ
`kubectl delete pod/sample-nginx-XXXXX-XXXXX`
### Scale ë³€ê²½ (2ê°œë¡œ ë³€ê²½)
`kubectl scale deployment sample-nginx --replicas=2`
Deploymentì˜ replica ìˆ˜ë¥¼ ë³€ê²½í•˜ì—¬ scaleì„ ì¡°ì ˆí•œë‹¤. ìœ„ ì˜ˆì œì—ì„œëŠ” 2ê°œì˜ replicaë¡œ ë³€ê²½í•˜ê³  ìˆë‹¤.
### Script ì‹¤í–‰
`kubectl apply -f sample1.yml`
YAML íŒŒì¼ì— ì •ì˜ëœ Kubernetes ë¦¬ì†ŒìŠ¤ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì ìš©í•œë‹¤.
### íŒŒë“œ í™•ì¸
`kubectl get pos -o wide`
Podsì˜ ëª©ë¡ì„ í‘œì‹œí•˜ë©´ì„œ ê° Podì˜ ìƒì„¸í•œ ì •ë³´ì™€ IP ì£¼ì†Œ ë“±ì„ í•¨ê»˜ í‘œì‹œí•œë‹¤.
### íŒŒë“œì— í„°ë„ë§ìœ¼ë¡œ ì ‘ì†
`kubectl exec -it nginx-deployment-XXXX-XXXX -- /bin/bash`
íŠ¹ì • Podì— ì ‘ì†í•˜ì—¬ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.
### íŒŒë“œ ë…¸ì¶œ(ê³µê°œ)
`kubectl expose deployment nginx-deployment --port=80 --type=NodePort`
Deploymentë¥¼ ì„œë¹„ìŠ¤ë¡œ ë…¸ì¶œì‹œí‚¤ê³ , ì™¸ë¶€ì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
NodePort íƒ€ì…ì˜ ì„œë¹„ìŠ¤ë¡œ 80ë²ˆ í¬íŠ¸ë¥¼ ë…¸ì¶œí•œë‹¤ëŠ” ëœ»ì´ë‹¤.

> [!NOTE] ë§Œë“  deploymentsë¥¼ ì‚­ì œí•  ë•Œ
> `kubectl create deployment sample-nginx --image=nginx`
deploymentë¥¼ ë§Œë“¤ë©´ sample-nginxì˜ podê°€ 1ê°œ ìƒì„±ëœë‹¤.
`kubectl delete pod/sample-nginx-56dfc8544d-5ffsj`
ë§Œë“¤ì–´ì§„ podë¥¼ ì‚­ì œí•´ë„ ìë™ìœ¼ë¡œ replicaì˜ ìˆ˜ë§Œí¼ ë‹¤ë¥¸ ì´ë¦„ì˜ podê°€ ìƒì„±ë¼ 1ê°œë¥¼ ìœ ì§€í•œë‹¤.
**deployment ìì²´ë¥¼ ì‚­ì œí•´ì•¼ podsë„ í•œêº¼ë²ˆì— ì‚­ì œëœë‹¤.**

## ì˜ˆì œ1 - ymlíŒŒì¼ë¡œ deployments, pod ìƒì„±

### 1. **ymlíŒŒì¼ ì‘ì„±**

**sample1.yml**
```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
        
```

### 2. **ëª…ë ¹ì–´ ì‹¤í–‰**
`kubectl apply -f sample1.yml`ì„ ì‹¤í–‰í•˜ë©´ replicasê°€ 2ê°œì¸ nginx-deploymentê°€ ìƒì„±ëœë‹¤.
![[sec4_2.png]]
## ì˜ˆì œ2 - Ansibleë¡œ kubenetes script ì‹¤í–‰

### 1. **ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ deploymentìƒì„±í•˜ëŠ” ymlíŒŒì¼ ì‘ì„±(Host PC)**

**cicd-devops-deployment.yml**
```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cicd-deployment
spec:
  selector:
    matchLabels:
      app: cicd-devops-project
  replicas: 2

  template:
    metadata:
      labels:
        app: cicd-devops-project
    spec:
      containers:
      - name: cicd-devops-project
        image: hyuxp/cicd-project-ansible
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        
```

### 2. **service ìƒì„±í•˜ëŠ” ymlíŒŒì¼ ì‘ì„±(Host PC)**

**cicd-devops-service.yml**
```yml
apiVersion: v1
kind: Service
metadata:
  name: cicd-service
  labels:
    app: cicd-devops-project
spec:
  selector:
    app: cicd-devops-project
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
      nodePort: 32000
      
```

### 3. **ìœ„ ymlíŒŒì¼ì„ ì‹¤í–‰í•˜ëŠ” playbook yml ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±(ansible-server)**

**k8s-cicd-deployment-playbook.yml**
ê¸°ì¡´ì— cicd-deploymentë¥¼ ì‚­ì œí•˜ê³  2ë²ˆì˜ ymlì„ ì‹¤í–‰í•˜ë¼ëŠ” ìŠ¤í¬ë¦½íŠ¸
```yml
- name: Create pods using deployment
  hosts: kubernetes
  # become: true
  # user: ubuntu

  tasks:
  - name: delete the previous deployment
    win_command: kubectl delete deployment.apps/cicd-deployment
    ignore_errors: yes

  - name: create a deployment
    win_command: kubectl apply -f C:\Users/ë°•ê²½í˜„_ì¸í„°ë„·ë§\Downloads\cicd-devops-deployment.yml
```

**k8s-cicd-service-playbook.yml**
2ë²ˆì˜ serviceìƒì„±í•˜ëŠ” ymlì„ ì‹¤í–‰í•˜ë¼ëŠ” ìŠ¤í¬ë¦½íŠ¸
```yml
- name: create service for deployment
  hosts: kubernetes
  # become: true
  # user: ubuntu

  tasks:
  - name: create a service
    win_command: kubectl apply -f C:\Users/ë°•ê²½í˜„_ì¸í„°ë„·ë§\Downloads\cicd-devops-service.yml
```

### 4. **ansible-playbookìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰**
`# ansible-playbook -i ./k8s/hosts k8s-cicd-deployment-playbook.yml`
`# ansible-playbook -i ./k8s/hosts k8s-cicd-service-playbook.yml`

## ì˜ˆì œ3 - Jenkins + Ansible + Kubernetes ì—°ë™
ì˜ˆì‹œ2ë²ˆ ê³¼ì •ì—ì„œ ansible-playbook ëª…ë ¹ì–´ë¥¼ ì§ì ‘ ì¹˜ì§€ ì•Šê³  jenkinsë¥¼ ì‚¬ìš©í•´ ì‹¤í–‰í•´ë³´ì

### 1. **Jenkins ê´€ë¦¬ - SSH Server ë“±ë¡**
k8sê°€ ì„¤ì¹˜ë˜ì–´ìˆëŠ” ì„œë²„ë¥¼ ìƒˆë¡œ ë“±ë¡í•œë‹¤.
- username, passwordëŠ” ìœˆë„ìš° ê³„ì • ì…ë ¥

![[sec4_3.png]]

### 2. **Item ìƒì„±**
ë¹Œë“œ í›„ ì»¤ë§¨ë“œì— ansible-playbook ëª…ë ¹ì–´ë¥¼ ë“±ë¡í•œë‹¤.
![[sec4_4.png]]

### 3. **ë°°í¬ í™•ì¸**
ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ pods, deployments, serviceê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```bash
hyun@DESKTOP-1S2IB77 C:\Users\ë°•ê²½í˜„_ì¸í„°ë„·ë§>kubectl get all
NAME                                   READY   STATUS    RESTARTS   AGE
pod/cicd-deployment-5b5795dcf7-jvf6v   1/1     Running   0          29s
pod/cicd-deployment-5b5795dcf7-rcmjt   1/1     Running   0          29s

NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/cicd-service   NodePort    10.108.44.15   <none>        8080:32000/TCP   21s
service/kubernetes     ClusterIP   10.96.0.1      <none>        443/TCP          2d1h

NAME                              READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cicd-deployment   2/2     2            2           29s

NAME                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/cicd-deployment-5b5795dcf7   2         2         2       29s
```

service í¬íŠ¸ì¸ localhost:32000ì— ì ‘ì†í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë°°í¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
![[sec4_5.png]]
## ì˜ˆì œ4 - CI/CD ìë™í™” íŒŒì´í”„ë¼ì¸ êµ¬ì¶•í•˜ê¸°
### êµ¬ì¡°
![[sec4_1.excalidraw]]
-  **CI**
1. ë³€ê²½ëœ ì†ŒìŠ¤ ê°ì§€ í›„ Git Pull
2. ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±
3. ë„ì»¤ í—ˆë¸Œì— ì´ë¯¸ì§€ push
4. ë¡œì»¬ì— ë§Œë“  ì´ë¯¸ì§€ ì‚­ì œ

- **CD**
1. k8s deployment ìƒì„±
2. k8s service ìƒì„±


---

### ğŸ’¡ Jenkins - CI í”„ë¡œì íŠ¸ ì¶”ê°€

### 1. ì†ŒìŠ¤ ë³€ê²½ ê°ì§€ ì„¤ì •
![[sec4_6.png|300]]
### 2. ë„ì»¤ ì´ë¯¸ì§€ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì»¤ë§¨ë“œ ì„¤ì •
![[sec4_7.png|400]]
### 3. ë¹Œë“œ ì™„ë£Œ ì‹œ CD í”„ë¡œì íŠ¸ ë˜í•œ ë¹Œë“œ í•˜ë„ë¡ ì„¤ì •
![[sec4_8.png|300]]

### ğŸ’¡ Jenkins - CDí”„ë¡œì íŠ¸ ì¶”ê°€

### 1. ì†ŒìŠ¤ ë³€ê²½ ì‹œ ì  í‚¨ìŠ¤ CI-Project ìë™ ë¹Œë“œ -> CD í”„ë¡œì íŠ¸ ë¹Œë“œ
### 2. Docker Image ìƒì„± ì»¤ë§¨ë“œ ì‹¤í–‰ 
`ansible-playbook -i ./k8s/hosts create-cicd-devops-image.yml --limit ansible-server` 

**create-cicd-devops-image.yml**
```yml
- hosts: all
#   become: true

  tasks:
  - name: create a docker image with deployed war file
    command: docker build -t hyuxp/cicd-project-ansible .
    args:
        chdir: /root

  - name: push the image on Docker Hub
    command: docker push hyuxp/cicd-project-ansible

  - name: remove the docker image from the ansible server
    command: docker rmi hyuxp/cicd-project-ansible
    ignore_errors: yes
```
### 3. CD-Project ë¹Œë“œ
### 4. k8s ë°°í¬ ì»¤ë§¨ë“œ ì‹¤í–‰ 
`ansible-playbook -i ./k8s/hosts k8s-cicd-deployment-playbook.yml;`
`ansible-playbook -i ./k8s/hosts k8s-cicd-service-playbook.yml;`

**k8s-cicd-deployment-playbook.yml**
```yml
- name: Create pods using deployment
  hosts: kubernetes
  # become: true
  # user: ubuntu

  tasks:
  - name: delete the previous deployment
    win_command: kubectl delete deployment.apps/cicd-deployment
    ignore_errors: yes

  tasks:
  - name: create a deployment
    win_command: kubectl apply -f C:\Users/ë°•ê²½í˜„_ì¸í„°ë„·ë§\Downloads\cicd-devops-deployment.yml
```
**k8s-cicd-service-playbook.yml**
```yml
- name: create service for deployment
  hosts: kubernetes
  # become: true
  # user: ubuntu

  tasks:
  - name: create a service
    win_command: kubectl apply -f C:\Users/ë°•ê²½í˜„_ì¸í„°ë„·ë§\Downloads\cicd-devops-service.yml
```

### 5. k8s deployment, service ìƒì„± ë° ë°°í¬
