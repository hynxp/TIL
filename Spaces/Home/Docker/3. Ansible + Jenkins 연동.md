## êµ¬ì¡°
![[sec3_1.webp]]
## ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ë¸Œë¦¿ì§€ í™•ì¸
`# docker network inspect bridge`

```json
{
	"Name": "bridge",
	"Containers": {
		"4d75fd0cb848eb6a23ae1736e203ae8fcd0dff310e2d79e33c206494e943bb0a": {
			"Name": "jenkins-server",
			"EndpointID": "d391074675fdd5f1004e8cdb902f90812d5ae845814c952374e59da3bb153e34",
			"MacAddress": "02:42:ac:11:00:03",
			"IPv4Address": "172.17.0.3/16",
			"IPv6Address": ""
		},
		"cdbb2a5b48bef63161026dcc5f68ab83696e1b99add1aa0c579048ce820c236d": {
			"Name": "docker-server",
			"EndpointID": "9eac29f8f8a99c0166c5dde6fb2dc6db1a9a2143d19f942d6e5a56ebcd93231f",
			"MacAddress": "02:42:ac:11:00:04",
			"IPv4Address": "172.17.0.4/16",
			"IPv6Address": ""
		},
		"ea3a4e776da2ee2fbc40bd82904109383311bc825a4da32827a0e9fa2a80ba36": {
			"Name": "ansible-server",
			"EndpointID": "75aff57b17699eff97d05c959c4327bfd981f7259fe58923b0cd9f6e5ccd5974",
			"MacAddress": "02:42:ac:11:00:02",
			"IPv4Address": "172.17.0.2/16",
			"IPv6Address": ""
		}
}
```
### host PC -> ê° ì»¨í…Œì´ë„ˆ ì ‘ì†
`# ssh root@localhost -p 20022`  
`# ssh root@localhost -p 10022`

### ì»¨í…Œì´ë„ˆ -> ì»¨í…Œì´ë„ˆ ê°„ ì ‘ì†
`# ssh root@172.17.0.2`  
`# ssh root@172.17.0.4`

### ssh í‚¤ ë“±ë¡
ì»¨í…Œì´ë„ˆ ê°„ì˜ ì ‘ì† ì‹œ ê³„ì† íŒ¨ìŠ¤ì›Œë“œë¥¼ ì¹˜ë©´ ë²ˆê±°ë¡œìš°ë‹ˆ sshí‚¤ë¥¼ ìƒì„±í•´ì„œ ì ‘ì†í•˜ê³ ì í•˜ëŠ” ì„œë²„ì— ì „ë‹¬í•˜ë©´ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ ì—†ì´ ë°”ë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤
`# ssh-keygen`
`# ssh-copy-id root@172.17.0.4`(ì ‘ì†í•  ì„œë²„ IP)

## Ansible ê¸°ë³¸ ëª…ë ¹ì–´
- **-i (--inventory-file)**
	ì ìš© ë  í˜¸ìŠ¤íŠ¸ë“¤ì— ëŒ€í•œ íŒŒì¼ ì •ë³´
-  **-m (--module-name)**
	ëª¨ë“ˆ ì„ íƒ
- **-k (--ask-pass)**
	ê´€ë¦¬ì ì•”í˜¸ ìš”ì²­
- **-K (--ask-become-pass)**
	ê´€ë¦¬ì ê¶Œí•œ ìƒìŠ¹
- **--list-hosts**
	ì ìš©ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ëª©ë¡

>[!NOTE]  Ansibleì€ ë©±ë“±ì„±ì„ ë³´ì¥í•œë‹¤.
ê°™ì€ ì„¤ì •ì„ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•˜ë”ë¼ê³ ë„ ë™ì¼í•œ ê²°ê³¼ë¥¼ ì–»ëŠ”ë‹¤ëŠ” ì˜ë¯¸ë‹¤.
ğŸ’¡ **í•­ìƒ ë©±ë“±ì„±ì´ ë³´ì¥ë˜ëŠ”ê°€?**
No! **command** ëª¨ë“ˆì€ ëª…ë ¹ì–´ë¥¼ ë¬´ì¡°ê±´ ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì— ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.
-> command ëª¨ë“ˆì€ ì‹¤í–‰ ê²°ê³¼ê°€ í•­ìƒ changedë¡œ ë‚˜ì˜¨ë‹¤.

## Ansible ëª¨ë“ˆ ì‚¬ìš©
[ëª¨ë“ˆ ëª©ë¡](https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html)

### ping - ì ‘ì† í™•ì¸ ëª¨ë“ˆ
 `# ansible all -m ping`
 `# ansible devops -m ping`
 - all
    - hosts íŒŒì¼ì— ìˆëŠ” ëŒ€ìƒ ì „ì²´ ë‹¤
- devops
    - hosts íŒŒì¼ì— ìˆëŠ” ê·¸ë£¹ëª…
- -m
    - ëª¨ë“ˆ ì‚¬ìš©
- ping
	- pingì´ë¼ëŠ” ëª¨ë“ˆì„ ì‚¬ìš©í•œë‹¤.

**ê²°ê³¼**
```shell
172.17.0.2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
172.17.0.4 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
```

### shell - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ë³´ ë°˜í™˜ ëª¨ë“ˆ
`# ansible all -m shell -a "free -h"`

**ê²°ê³¼**
```shell
172.17.0.2 | CHANGED | rc=0 >>
total        used        free      shared  buff/cache   available
Mem:           15Gi       1.8Gi       9.6Gi        30Mi       4.1Gi        13Gi
Swap:         4.0Gi          0B       4.0Gi
172.17.0.4 | CHANGED | rc=0 >>
total        used        free      shared  buff/cache   available
Mem:           15Gi       1.8Gi       9.6Gi        30Mi       4.1Gi        13Gi
Swap:         4.0Gi          0B       4.0Gi
```

### yum - íŒ¨í‚¤ì§€ ì„¤ì¹˜ ëª¨ë“ˆ
`# ansible devops -m yum -a "name=httpd state=present"`

## Playbook ì‚¬ìš©í•˜ê¸°
ëª¨ë“ˆì— ëŒ€í•œ ëª…ë ¹ì–´ë¥¼ ì‘ì„±í•´ë†“ê³  í•œêº¼ë²ˆì— ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

### ì˜ˆì œ1 - blockinfile ëª¨ë“ˆ ì‚¬ìš©
ë§ˆì»¤ ì„ ìœ¼ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì—¬ëŸ¬ ì¤„ì˜ í…ìŠ¤íŠ¸ ë¸”ë¡ ì‚½ì…í•˜ëŠ” ëª¨ë“ˆì´ë‹¤.

**yml ì˜ˆì œ**
```yaml
---
  - name: Add an ansible hosts
    hosts: localhost
    tasks:
      - name: Add a ansible hosts
        blockinfile:
          path: /etc/ansible/hosts
          block: |
            [mygroup]
            172.17.0.5
```

**playbook ëª…ë ¹ì–´ ì‹¤í–‰**
 `# ansible-playbook first-playbook.yml`
 
**ê²°ê³¼**
hosts íŒŒì¼ì— block: ì•„ë˜ì— ì ì€ í…ìŠ¤íŠ¸ê°€ ì‚½ì…ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```shell
# cat /etc/ansible/hosts 
[devops]
172.17.0.2 
172.17.0.4
# BEGIN ANSIBLE MANAGED BLOCK
[mygroup]
172.17.0.5
# END ANSIBLE MANAGED BLOCK
```

> [!NOTE]
Content2ë²ˆ ê³¼ì •ì„ í•œ ë²ˆ ë” í•œë‹¤ê³  í•´ë„ hostê°€ ë˜ ì¶”ê°€ë˜ì§€ ì•ŠëŠ”ë‹¤.
ì•„ê¹Œ ë§í–ˆë˜ **ë©±ë“±ì„±**ë•Œë¬¸ì´ë‹¤!!! 


### ì˜ˆì œ2 - copy ëª¨ë“ˆ ì‚¬ìš©
íŒŒì¼ì„ ë³µì‚¬í•˜ëŠ” ëª¨ë“ˆì´ë‹¤.

**yml ì˜ˆì œ**
```yml
- name: Ansible Copy Example Local to Remtoe 
  hosts: devops
  tasks:
    - name: copying file with playbook
      copy:
        src: ~/sample.txt
        dest: /tmp
        owner: root
        mode: 0644
```


### ì˜ˆì œ3 - file, get_url ëª¨ë“ˆ ì‚¬ìš©

íŒŒì¼ ë‹¤ìš´ë¡œë“œ urlì„ ê°€ì ¸ì™€ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•´ë³´ì
```yml
---
- name: tomcat.apache.orgì—ì„œ Tomcat9 ë‹¤ìš´ë¡œë“œ í•´ë³´ê¸°
  hosts: all
  #become: yes
  # become_user: root
  tasks:
   - name: /opt/tomcat9 ë””ë ‰í† ë¦¬ ìƒì„± 
     file:
       path: /opt/tomcat9
       state: directory
       mode: 0755
   - name: Tomcat checksum ë‹¤ìš´ë¡œë“œ
     get_url:
       url: https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.86/bin/apache-tomcat-9.0.86.tar.gz.sha512
       dest: /opt/tomcat9/apache-tomcat-9.0.86.tar.gz.sha512
   - name: checksum value ë“±ë¡
     shell: cat /opt/tomcat9/apache-tomcat-9.0.86.tar.gz.sha512 | grep apache-tomcat-9.0.86.tar.gz | awk '{ print $1 }'
     register: tomcat_checksum_value
   - name: get_urlì„ ì‚¬ìš©í•˜ì—¬ tomcat9 ë‹¤ìš´ë¡œë“œ
     get_url:
       url: https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.86/bin/apache-tomcat-9.0.86.tar.gz
       dest: /opt/tomcat9
       mode: 0755
       checksum: sha512:{{ tomcat_checksum_value.stdout }}"
```

## Jenkins + Playbook ì‚¬ìš©í•˜ê¸°

**first-devops-playbook.yml**
```yml
- hosts: all
#   become: true  

  tasks:
  - name: build a docker image with deployed war file
    command: docker build -t cicd-project-ansible .
    args: 
        chdir: /root

  - name: create a container using cicd-project-ansible image
    command: docker run -d --name my_cicd_project -p 8080:8080 cicd-project-ansible
```

ğŸ’¡ ì—¬ê¸°ì„œ í¬íŠ¸ëŠ” ì™œ **8080:8080**ì¼ê¹Œ?

![[sec3_1.excalidraw]]

ì•ì„œ host PC(ì‹¤ì œ ì»´í“¨í„°)ì—ì„œ ansible serverë¥¼ **8082:8080**ë¡œ ì‹¤í–‰ì‹œì¼°ë‹¤.
(localhost:8082ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ansible server ë‚´ë¶€ì—ì„œ 8080í¬íŠ¸ê°€ ì‘ë‹µí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ë‹¤.)

ì¦‰ 8080í¬íŠ¸ê°€ ì‘ë‹µí•˜ê¸° ë•Œë¬¸ì— ansible serverë‚´ì— ì»¨í…Œì´ë„ˆì—ì„œëŠ” 8080ì˜ ìš”ì²­ì„ ë°›ì•„ì•¼ í•œë‹¤.
**8080**:8080, **8080**:8081 ì•ì—ë§Œ 8080ì´ë©´ ëœë‹¤.

### 1.Jenkinsì— SSH ì„œë²„ ë“±ë¡
Jenkins ê´€ë¦¬ - SSH Serverì— ansible-server ë“±ë¡
![[sec3_2.png|250]]

### 2.  í”„ë¡œì íŠ¸ ì„¤ì •
í•´ë‹¹ í”„ë¡œì íŠ¸ **ë¹Œë“œ í›„ ì¡°ì¹˜**ì— war íŒŒì¼ì´ ë¹Œë“œë˜ë©´ ansible-serverì—ì„œ ansible-playbook.ymlì— ë“±ë¡í•œ ëª…ë ¹ì–´ê°€ ìë™ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•œë‹¤.
![[sec3_3.png|250]]

### 3. localhost:8082ë¡œ ì ‘ì†í•´ì„œ í™•ì¸
![[sec3_4.png|250]]

### ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€, ì‚­ì œ ëª…ë ¹ì–´ ì¶”ê°€
ì´ ìƒíƒœì—ì„œ ê°™ì€ ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ UNSTABLE ì—ëŸ¬ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— 
playbook íŒŒì¼ì—ì„œ **ê¸°ì¡´ì— ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©´ ì¤‘ì§€í•˜ê³  ì‚­ì œ**í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì¶”ê°€í•œë‹¤.

```yml
- hosts: all
#   become: true  

  tasks:
  - name: ì»¨í…Œì´ë„ˆ ì¤‘ì§€
    command: docker stop my_cicd_project
    ignore_errors: yes

  - name: ì»¨í…Œì´ë„ˆ ì‚­ì œ
    command: docker rm my_cicd_project
    ignore_errors: yes

  - name: ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
    command: docker rmi cicd-project-ansible
    ignore_errors: yes

  - name: Dockerfileë¡œ ì´ë¯¸ì§€ ìƒì„±
    command: docker build -t cicd-project-ansible .
    args: 
        chdir: /root

  - name: ì»¨í…Œì´ë„ˆ ìƒì„± ë° ì‹¤í–‰
    command: docker run -d --name my_cicd_project -p 8080:8080 cicd-project-ansible
```

## Docker Hubì— ë“±ë¡í•œ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰í•´ë³´ê¸°
ğŸ’¡ **ì•„ë˜ ì‘ì—…ì€ Ansible Serverì—ì„œ í•´ì•¼ í•œë‹¤.**
### Dockerfile
```
FROM tomcat:9.0
LABEL org.opencontainers.image.authors="edowon0623@gmail.com"
COPY ./hello-world.war /usr/local/tomcat/webapps
```

### 1. hosts íŒŒì¼ì— docker-server ip ì¶”ê°€
```
172.17.0.2 <- ansible-server
172.17.0.4 <- docker-server
```

### 2. ì´ë¯¸ì§€ ìƒì„±  + Docker Hubì— pushí•˜ëŠ” yml ìƒì„±
Dockerfileë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³ , Docker Hubì— pushí•œ ë’¤ì— ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•œë‹¤.
```yml
- hosts: all
#   become: true

  tasks:
  - name: Dockerfile ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±
    command: docker build -t hyuxp/cicd-project-ansible .
    args: 
        chdir: /root
    
  - name: Docker Hubì— push
    command: docker push hyuxp/cicd-project-ansible

  - name: ìƒì„±í•œ ì´ë¯¸ì§€ ì‚­ì œ
    command: docker rmi hyuxp/cicd-project-ansible  
    ignore_errors: yes
```

### 3. Docker Hubì—ì„œ pull + ì»¨í…Œì´ë„ˆ ìƒì„±í•˜ëŠ” yml ìƒì„±
ê¸°ì¡´ì— ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì¤‘ì§€, ì‚­ì œí•˜ê³ 
2ë²ˆ ê³¼ì •ì—ì„œ ìƒˆë¡­ê²Œ pushëœ ì´ë¯¸ì§€ë¥¼ pullí•œ ë‹¤ìŒ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•œë‹¤.
```yml
- hosts: all
#   become: true  

  tasks:
  - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
    command: docker stop my_cicd_project
    ignore_errors: yes

  - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
    command: docker rm my_cicd_project
    ignore_errors: yes

  - name: ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
    command: docker rmi hyuxp/cicd-project-ansible
    ignore_errors: yes

  - name: Docker Hubì—ì„œ ì´ë¯¸ì§€ pull
    command: docker pull hyuxp/cicd-project-ansible

  - name: ì»¨í…Œì´ë„ˆ ìƒì„±
    command: docker run -d --name my_cicd_project -p 8080:8080 hyuxp/cicd-project-ansible

```

### 4. Jenkinsì—ì„œ playbook ëª…ë ¹ì–´ ì‹¤í–‰
Jenkinsì—ì„œ ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ 2, 3ë²ˆì˜ ymlíŒŒì¼ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •í•˜ì.
![[sec3_5.png|250]]
`# ansible-playbook -i hosts create-cicd-devops-image.yml --limit 172.17.0.4`
`# ansible-playbook -i hosts create-cicd-devops-container.yml --limit 172.17.0.2`
--limitëŠ” hostsíŒŒì¼ ì¤‘ì— ì´ ipì—ê²Œë§Œ playbookì„ ì‹¤í–‰ì‹œí‚¤ê² ë‹¤ëŠ” ëœ»ì´ë‹¤.
> [!NOTE] ìš”ì•½
> 1. ansibleì´ ì„¤ì¹˜ëœ ì»¨í…Œì´ë„ˆì— ëª…ë ¹ì–´ë¥¼ ymlë¡œ ë§Œë“ ë‹¤.
> 2. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë“¤ì˜ ì •ë³´ê°€ ë‹´ê¸´ hostsíŒŒì¼ì„ ìƒì„±í•œë‹¤.
> 3. ansible-playbook ëª…ë ¹ì–´ë¡œë¡œ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì‹œí‚¤ë“¯ì´ ì»¨í…Œì´ë„ˆë“¤ì„ ì¡°ì¢…í•œë‹¤!
> 4. 3ë²ˆ ê³¼ì •ì„ **Jenkins ë¹Œë“œ í›„ ì¡°ì¹˜ì— Exec command**ì— ì…ë ¥í•˜ë©´ ìë™í™”í•  ìˆ˜ ìˆë‹¤.
